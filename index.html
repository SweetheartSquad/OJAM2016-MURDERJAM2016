<!doctype html>
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
    
    <style>
        html,body{
            padding:0;
            margin:0;
        }
        canvas, img {
            image-rendering: optimizeSpeed;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
        }
    </style>
</head>

<body>
<script src="pixi.min.js"></script>
<script>
    
    // create renderer
    var size = [1920, 1080];
    var ratio = size[0] / size[1];
    var renderer = PIXI.autoDetectRenderer(
        size[0],size[1],
        {antiAlias:false, transparent:false, resolution:1}
    );
    PIXI.SCALE_MODES.DEFAULT = PIXI.SCALE_MODES.NEAREST;
    renderer.backgroundColor = 0xFF0000;
    renderer.view.style.position = "absolute";
    renderer.view.style.display = "block";
    window.onresize = onResize;
    
    // add the canvas to the html document
    document.body.appendChild(renderer.view);
    
    // create stage a container object 
    var scene = new PIXI.Container();
    
    
    PIXI.loader
        .add("bro", "assets/text/bro.json")
        .add("pro", "assets/text/pro.json")
        .add("art", "assets/text/art.json")
        .add("odd", "assets/text/odd.json")
        .add("new", "assets/text/new.json")
        .add("app", "assets/text/app.json")
        .add("assets/intro_0.png")
        .add("assets/intro_1.png")
        .add("assets/intro_2.png")
        .add("assets/intro_3.png")
        .add("bg", "assets/bg.png")
        .add("speechBubble", "assets/speechBubble.png")
        .add("btnListen", "assets/btns/listen.png")
        .add("btnBio", "assets/btns/bio.png")
        .add("btnX", "assets/btns/x.png")
        .add("btnAccuse", "assets/btns/accuse.png")
        .add("bioBg", "assets/bioBg.png")
        .add("assets/textures.json")
        .on("progress", loadProgressHandler)
        .load(setup);
    
    
    function loadProgressHandler(loader, resource){
        // called during loading
        
        console.log("loading: " + resource.url);
        console.log("progress: " + loader.progress+"%");
        
    }
    
    var jammers = {
        "bro":{
            name:"Austin",
            pos:{x:0.2,y:0.5},
            btnpos:0.5,
            color:"#FF3333",
            age:"23",
            job:"Student (6th year)",
            style:"Retro Platformer",
            traits:[
                "outgoing",
                "supportive"
            ]
        },
        "pro":{
            name:"Kevin",
            pos:{x:0.2,y:0.5},
            btnpos:0.5,
            color:"#FF3333",
            age:"26",
            job:"Professional Jammer",
            style:"Unity Die-hard",
            traits:[
                "blunt",
                "principled"
            ]
        },
        "art":{
            name:"Mackenzie",
            pos:{x:0.2,y:0.5},
            btnpos:0.5,
            color:"#FF3333",
            age:"19",
            job:"Professional Dropout",
            style:"Artist",
            traits:[
                "apathetic"
            ]
        },
        "odd":{
            name:"@brrrrdd",
            pos:{x:0.2,y:0.5},
            btnpos:0.5,
            color:"#FF3333",
            age:"???",
            job:"???",
            style:"Weird Games",
            traits:[
                "withdrawn",
                "observant"
            ]
        },
        "new":{
            name:"Hazel",
            pos:{x:0.2,y:0.5},
            btnpos:0.5,
            color:"#FF3333",
            age:"21",
            job:"Student",
            style:"Twine Initiate",
            traits:[
                "cheerful",
                "curious"
            ]
        },
        "app":{
         name:"Jess",
            pos:{x:0.2,y:0.5},
            btnpos:0.5,
            color:"#FF3333",
            age:"21",
            job:"Software Developer",
            style:"Mobile Free-to-play",
            traits:[
                "outgoing",
                "driven"
            ]
        }
    };
    currentJammer = null;
    
    
    var menu = new PIXI.Container();
    menu.currentFrame = 0;
    var game = new PIXI.Container();
    
    function setup(){
        // called when loader completes
        console.log("All files loaded");


        
        menu.frames = [];
        for(var i = 0; i <= 3; ++i){
            var sprite = new PIXI.Sprite(PIXI.utils.TextureCache["assets/intro_"+i+".png"]);
            sprite.width = size[0];
            sprite.height = size[1];
            if(i != 0){
                sprite.visible = false;
            }
            menu.frames.push(sprite);
            menu.addChild(sprite);
        }
        menuClick = new PIXI.Text("Click to continue",{
            font:"bold 24px Georgia"
        });
        menuClick.anchor.x = 0.5;
        menuClick.x = size[0]/2;
        menuClick.y = size[1]-100;
        menuClick.buttonMode = true;
        menuClick.interactive = true;
        menuClick.on("click", nextFrame);
        menu.addChild(menuClick);
        
        
        
        game.bg = new PIXI.Sprite(PIXI.loader.resources.bg.texture);
        game.bg.width = size[0];
        game.bg.height = size[1];
        game.addChild(game.bg);

        for(var k in jammers){
            if(k == "bro"){
            var jammer = jammers[k];
            
            jammer.lines = PIXI.loader.resources[k].data.lines;
            
            jammer.grp = new PIXI.Container();
            jammer.btngrp = new PIXI.Container();
                
            jammer.grp.x = jammer.pos.x * size[0];
            jammer.grp.y = jammer.pos.y * size[1];
            
            
            // animations
            jammer.idleFrames = [];
            for (var i = 0; i < 4; i++) {
                var s = k;
                s += "_idle_";
                s += i;
                s += ".gif";
                // magically works since the spritesheet was loaded with the pixi loader
                jammer.idleFrames.push(PIXI.Texture.fromFrame(s));
            }
            
            jammer.idle = new PIXI.extras.MovieClip(jammer.idleFrames);
            jammer.idle.animationSpeed = 0.16;
            jammer.idle.anchor.x = 0.5;
            jammer.idle.anchor.y = 1;
            
            jammer.idle.play();
            jammer.grp.addChild(jammer.idle);
            
            
            jammer.talkFrames = [];
            for (var i = 0; i < 4; i++) {
                var s = k;
                s += "_talk_";
                s += i;
                s += ".gif";
                // magically works since the spritesheet was loaded with the pixi loader
                jammer.talkFrames.push(PIXI.Texture.fromFrame(s));
            }
            jammer.talk = new PIXI.extras.MovieClip(jammer.talkFrames);
            jammer.talk.animationSpeed = 0.16;
            jammer.talk.anchor.x = 0.5;
            jammer.talk.anchor.y = 0;
                
            jammer.grp.addChild(jammer.talk);
            jammer.talk.visible = false;
                
                
                
                
            
            
            // interaction buttons
            jammer.btnListen = new PIXI.Sprite(PIXI.loader.resources.btnListen.texture);
            jammer.btnListen.anchor.x = 0.5;
            jammer.btnListen.anchor.y = 1;
            jammer.btnListen.x -= 64;
            jammer.btnListen.buttonMode = true;
            jammer.btnListen.interactive = true;
            jammer.btnListen.on("click", sayNextLine.bind(jammer));
            jammer.btnListen.on("mouseover", onMouseOver.bind(jammer));
            jammer.btnListen.on("mouseout", onMouseOut);
            jammer.btngrp.addChild(jammer.btnListen);
            
                
            jammer.btnBio = new PIXI.Sprite(PIXI.loader.resources.btnBio.texture);
            jammer.btnBio.anchor.x = 0.5;
            jammer.btnBio.anchor.y = 1;
            jammer.btnBio.buttonMode = true;
            jammer.btnBio.interactive = true;
            jammer.btnBio.on("click", viewBio.bind(jammer));
            jammer.btnBio.on("mouseover", onMouseOver.bind(jammer));
            jammer.btnBio.on("mouseout", onMouseOut);
            jammer.btngrp.addChild(jammer.btnBio);
            
                
            jammer.btnAccuse = new PIXI.Sprite(PIXI.loader.resources.btnAccuse.texture);
            jammer.btnAccuse.anchor.x = 0.5;
            jammer.btnAccuse.anchor.y = 1;
            jammer.btnAccuse.x += 64;
            jammer.btnAccuse.buttonMode = true;
            jammer.btnAccuse.interactive = true;
            jammer.btnAccuse.on("click", accuse.bind(jammer));
            jammer.btnAccuse.on("mouseover", onMouseOver.bind(jammer));
            jammer.btnAccuse.on("mouseout", onMouseOut);
            jammer.btngrp.addChild(jammer.btnAccuse);
                
                
                
            // name label
            jammer.label = new PIXI.Text(jammer.name, {
                font:'bold 24px Georgia',
                fill:"#FFF",
                stroke : jammer.color,
                strokeThickness : 5
            });
            jammer.label.anchor.x = 0.5;
            jammer.label.anchor.y = 0;
                
            jammer.btngrp.addChild(jammer.label);
                
            game.addChild(jammer.grp);
                
                
            jammer.btngrp.y = -jammer.btnpos * jammer.grp.height;
            jammer.grp.addChild(jammer.btngrp);
            }
        }

        speechBubble = new PIXI.Sprite(PIXI.loader.resources.speechBubble.texture);
        speechBubble.width = size[0];
        speechBubble.height = size[1];
        game.addChild(speechBubble);
        
        feed = new PIXI.Text("",{
            font:'bold 24px Georgia'
        });
        feed.x = size[0]*0.25;
        feed.y = size[1]*0.75;
        feed.style.wordWrap = true;
        feed.style.wordWrapWidth = size[0]*0.5;
        feed.targetText = "";
        feed.charOffset = 0;
        game.addChild(feed);

        
        bio = new PIXI.Container();
        bio.bg = new PIXI.Sprite(PIXI.loader.resources.bioBg.texture);
        bio.bg.width = size[0];
        bio.bg.height = size[1];
        bio.addChild(bio.bg);
        
        bio.nameLabel = new PIXI.Text("Name: ",{
            font:"bold 24px Georgia"
        });
        bio.nameLabel.x = size[0]*0.36;
        bio.nameLabel.y = size[1]*0.33;
        bio.nameLabel.rotation = -0.025;
        
        bio.ageLabel = new PIXI.Text("Age: ",{
            font:"24px Georgia"
        });
        bio.ageLabel.x = size[0]*0.33;
        bio.ageLabel.y = size[1]*0.4;
        bio.ageLabel.rotation = -0.025;
        
        bio.jobLabel = new PIXI.Text("Job: ",{
            font:"24px Georgia"
        });
        bio.jobLabel.x = size[0]*0.33;
        bio.jobLabel.y = size[1]*0.45;
        bio.jobLabel.rotation = -0.025;
        
        bio.styleLabel = new PIXI.Text("Style: ",{
            font:"24px Georgia"
        });
        bio.styleLabel.x = size[0]*0.33;
        bio.styleLabel.y = size[1]*0.5;
        bio.styleLabel.rotation = -0.025;
        
        bio.traitsLabel = new PIXI.Text("Traits: ",{
            font:"24px Georgia"
        });
        bio.traitsLabel.x = size[0]*0.33;
        bio.traitsLabel.y = size[1]*0.6;
        bio.traitsLabel.rotation = -0.025;
        
        bio.btnX = new PIXI.Sprite(PIXI.loader.resources.btnX.texture);
        bio.btnX.x = size[0]*0.575;
        bio.btnX.y = size[1]*0.18;
        bio.btnX.buttonMode = true;
        bio.btnX.interactive = true;
        bio.btnX.on("click", closeBio);
        bio.btnX.on("mouseover", onMouseOver);
        bio.btnX.on("mouseout", onMouseOut);
        
        bio.addChild(bio.nameLabel);
        bio.addChild(bio.ageLabel);
        bio.addChild(bio.jobLabel);
        bio.addChild(bio.styleLabel);
        bio.addChild(bio.traitsLabel);
        bio.addChild(bio.btnX);
        game.addChild(bio);
        
        scene.addChild(menu);
        scene.addChild(game);
        game.visible = false;
        
        onResize();
        closeBio();
        main();
    }
    
    var currentLine = -1;
    
    function main(){
        
        if(game.visible){
            if(feed.charOffset < feed.targetText.length){
                feed.text += feed.targetText.substr(feed.charOffset,1);
                feed.charOffset += 1;
            }
        }
        
        renderer.render(scene);
        requestAnimationFrame(main);
    }
    
    
    function nextFrame(){
        menu.frames[menu.currentFrame].visible = false;
        menu.currentFrame += 1;
        if(menu.currentFrame < menu.frames.length){
            menu.frames[menu.currentFrame].visible = true;
        }else{
            menu.visible = false;
            game.visible = true;
        }
    }
    
    function sayNextLine(event){
        var switched = currentJammer != this;
        currentJammer = this;
        currentLine += 1;
        if(currentLine < currentJammer.lines.length){
            feed.targetText = currentJammer.lines[currentLine];
        }else{
            feed.targetText = getEnder();
        }
        feed.text = currentJammer.name + ":\n" + (switched ? getStarter() : "");
        feed.charOffset = 0;
        feed.style.fill = currentJammer.color;
            
    }
    function viewBio(event){
        bio.visible = true;
        bio.nameLabel.text = "Name: " + this.name;
        bio.ageLabel.text = "Age: " + this.age;
        bio.jobLabel.text = "Job: " + this.job;
        bio.styleLabel.text = "Style: " + this.style;
        bio.traitsLabel.text = "Traits:\n•" + this.traits.join("\n•");
    }
    function closeBio(event){
        bio.visible = false;
    }
    function accuse(event){
        // do something
    }
    
    
    // tint buttons on hover
    function onMouseOver(event){
        if(this.color){
            event.target.tint = parseInt(this.color.substr(1),16);
        }else{
            event.target.tint = 0x999999;
        }
    }
    function onMouseOut(event){
        event.target.tint = 0xFFFFFF; 
    }
    
    
    // returns a random little starter sentence thing
    function getStarter(){
        var t=[
            "...anyway - ",
            "So as I was saying - ",
            "...where was I? Oh - "
        ];
        var r = Math.floor(Math.random()*t.length);
        return t[r];
    }
    
    // returns a random little ending sentence thing
    function getEnder(){
        var t=[
            "That's basically what happened.",
            "I think I said everything I know.",
            "Now what?"
        ];
        var r = Math.floor(Math.random()*t.length);
        return t[r];
    }
    
    function onResize() {
        if (window.innerWidth / window.innerHeight >= ratio) {
            var w = window.innerHeight * ratio;
            var h = window.innerHeight;
        } else {
            var w = window.innerWidth;
            var h = window.innerWidth / ratio;
        }
        renderer.view.style.width = w + 'px';
        renderer.view.style.height = h + 'px';
    }

</script>
</body>